\ information                                                                                                                   A Z80 assembler with local labels is based on J. Cassady        8080 forth assembler (Forth Dimensions III/6).                                                                                  INTEL mnemonics are used.  Z80 specific instructions use        TDL 'extended INTEL' mnemonics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ load block                                                    forth definitions  hex  sys @  system  warning @  warning off                                                                   marker -ASM                                                                                                                     cr .( loading Z80 Assembler )  2 #screens 1- thru                                                                               forth definitions  decimal  warning !  sys !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ vocabularies                                                  vocabulary ASSEMBLER   assembler definitions                                                                                    2variable avoc                                                                                                                  : rel ( a1 a2 -- offs )                                           1+ - dup 80 -80 within abort" branch out of range" ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \ labels                                                        #20 constant ml  \ max labels                                   #25 constant mf  \ max forward references                                                                                       create lt  ml 2* allot     \ label table                        create ft  mf 2* 2* allot  \ forward reference table                                                                            \ reset labels                                                  : !lb  ( -- )                                                     lt [ ml 2* ] literal erase                                      ft [ mf 2* 2* ] literal erase ;  !lb                                                                                                                                                                                                                                                                                                                                                          \ labels                                                        \ resolve all forward references                                : ?lb ( -- )                                                      mf 0 do                                                           i 2* 2*  ft +  2@  dup if ( fwd ref )                             swap  2*  lt +  @  dup 0= abort" unresolved reference"          over 1- c@ ( opc )                                              dup 0C7 and 0=  swap 30 and  and  \ rel jmp ?                   if over rel  swap c!  else  swap !  then                      else  2drop  then                                             loop ;                                                                                                                                                                                                                                                                                                                                                                                        \ labels                                                        \ add address to forward reference table                        : fwd ( adr -- )  here 1+ ( skip opcode )                         mf 1+  0 do                                                       i mf = abort" too many references"                              i 2* 2*  ft +  dup @                                            if  drop  else  tuck !  cell+ !  0 0 leave  then              loop 2drop ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ labels                                                        \ check label number                                            : ?l ( n -- n )                                                   1-  dup ml 0 within abort" invalid label" ;                                                                                   \ declare label                                                 : $: ( n -- )                                                     ?l 2* lt +  dup @ abort" duplicate label"  here swap ! ;                                                                      \ get label address                                             : $ ( n -- a )                                                    ?l dup 2* lt +  @ tuck                                          if  drop  else  fwd  drop here ( dummy adr) then ;                                                                                                                                                                                                            \ modes                                                         variable <xy>  ( ix/iy mode )                                   variable dsp   ( ix/iy displacement )                                                                                           : ?xy   <xy> @ 1 = if  -1 allot  then  <xy> off ;               : ?dsp  <xy> @ 2 = if  dsp @ c,  then  <xy> off ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ instruction class                                             :  1m  constant does> c@ c, ;                                   :  2m  constant does> c@ + c, ?dsp ;                            :  3m  constant does> c@ swap 8 * + c, ?dsp ;                   :  4m  constant does> c@ c, c, ;                                :  5m  constant does> c@ c, , ;                                 :  6m  constant does> c@ c, here rel c, ;                       :  7m  constant does> 0ED c, c@ c, ;                            :  8m  constant does> 0ED c, c@ c, , ;                          :  9m  constant does> 0CB c, ?dsp c@ + c, ;                     : 10m  constant does> 0CB c, ?dsp c@ swap 8 * + + c, ;          : 11m  value does> @ , ;                                        : 12m  value does> @ , , ;                                      : 13m  value does> count c, ?xy c@ swap 8 * + c, ;                                                                                                                                              \ mnemonics                                                     000 1m NOP   007 1m RLC   008 1m EXAF  00F 1m RRC   017 1m RAL  01F 1m RAR   027 1m DAA   02F 1m CMA   037 1m STC   03F 1m CMC  076 1m HLT   0C0 1m RNZ   0C8 1m RZ    0C9 1m RET   0D0 1m RNC  0D8 1m RC    0D9 1m EXX   0E0 1m RPO   0E3 1m XTHL  0E8 1m RPE  0E9 1m PCHL  0EB 1m XCHG  0F0 1m RP    0F3 1m DI    0F8 1m RM   0F9 1m SPHL  0FB 1m EI                                                                                                          080 2m ADD   088 2m ADC   090 2m SUB   098 2m SBB   0A0 2m ANA  0A8 2m XRA   0B0 2m ORA   0B8 2m CMP                                                                                            002 3m STAX  003 3m INX   004 3m INR   005 3m DCR   009 3m DAD  00A 3m LDAX  00B 3m DCX   0C1 3m POP   0C5 3m PUSH  0C7 3m RST                                                                                                                                                                                                  \ mnemonics                                                     0C6 4m ADI   0CE 4m ACI   0D3 4m OUT   0D6 4m SUI   0DB 4m IN   0DE 4m SBI   0E6 4m ANI   0EE 4m XRI   0F6 4m ORI   0FE 4m CPI                                                                  022 5m SHLD  02A 5m LHLD  032 5m STA   03A 5m LDA   0C2 5m JNZ  0C3 5m JMP   0C4 5m CNZ   0CA 5m JZ    0CC 5m CZ    0CD 5m CALL 0D2 5m JNC   0D4 5m CNC   0DA 5m JC    0DC 5m CC    0E2 5m JPO  0E4 5m CPO   0EA 5m JPE   0EC 5m CPE   0F2 5m JP    0F4 5m CP   0FA 5m JM    0FC 5m CM                                                                                                          010 6m DJNZ  018 6m JMPR  020 6m JRNZ  028 6m JRZ   030 6m JRNC 038 6m JRC                                                                                                                                                                                                                                                                                                                      \ mnemonics                                                     044 7m NEG   045 7m RETN  046 7m IM0   047 7m STAI  04D 7m RETI 04F 7m STAR  056 7m IM1   057 7m LDAI  05E 7m IM2   05F 7m LDAR 067 7m RRD   06F 7m RLD   0A0 7m LDI   0A1 7m CCI   0A2 7m INI  0A3 7m OUTI  0A8 7m LDD   0A9 7m CCD   0AA 7m IND   0AB 7m OUTD 0B0 7m LDIR  0B1 7m CCIR  0B2 7m INIR  0B3 7m OUTIR 0B8 7m LDDR 0B9 7m CCDR  0BA 7m INDR  0BB 7m OUTDR                                                                                          043 8m SBCD  04B 8m LBCD  053 8m SDED  05B 8m LDED  073 8m SSPD 07B 8m LSPD                                                                                                                     000 9m RLCR  008 9m RRCR  010 9m RALR  018 9m RARR  020 9m SLAR 028 9m SRAR  038 9m SRLR                                                                                                                                                                                                                                        \ mnemonics                                                     040 10m BIT   080 10m RES   0C0 10m SET                                                                                         0E3DD 11m XTIX  0E9DD 11m PCIX  0F9DD 11m SPIX  0E3FD 11m XTIY  0E9FD 11m PCIY  0F9FD 11m SPIY                                                                                                  022DD 12m SIXD  022FD 12m SIYD  02ADD 12m LIXD  02AFD 12m LIYD                                                                  009DD 13m DADX  009FD 13m DADY  040ED 13m INP   041ED 13m OUTP  042ED 13m DSBC  04AED 13m DADC                                                                                                  : MOV  8 * 40 + + c, ?dsp ;                                     : MVI  8 * 6 + c, ?dsp c, ;                                     : LXI  8 * 1+ c, , ;                                                                                                                                                                            \ registers                                                          aka 0 B         aka 1 C         aka 2 D         aka 3 E    4 constant H    5 constant L    6 constant M    6 constant PSW  6 constant SP   7 constant A                                                                                                    : X ( -- 4 )  0DD c,  1 <xy> !  4 ;                             : Y ( -- 4 )  0FD c,  1 <xy> !  4 ;                                                                                             : (X) ( n -- 6 )  dsp !  0DD c,  2 <xy> !  6 ;                  : (Y) ( n -- 6 )  dsp !  0FD c,  2 <xy> !  6 ;                                                                                                                                                                                                                                                                                                                                                                                                                  \ interface                                                     \ kernel address                                                'next 4 -      constant RPP     \ return stack pointer          ' :  1+ @      constant DOCOL   \ enter colon routine           ' (exit) 3 +   constant EXIT1   \ exit colon routine            ' -   3 + @    constant DSUB    \ subtract HL DE                ' u<  3 + @    constant CMPU    \ unsigned compare HL DE        ' max 3 + @    constant CMPS    \ signed compare HL DE          ' um* 3 + @    constant MULX    \ unsigned double multiply      ' um/mod 7 + @ constant DIVX    \ unsigned double divide                                                                                                                                                                                                                                                                                                                                                                                                        \ interface                                                     \ macros                                                        : NEXT   'next jmp ;                \ jmp to NEXT               : 1PUSH  'next 1- jmp ;             \ push HL jmp NEXT          : 2PUSH  'next 2- jmp ;             \ push DE push HL jmp NEXT  : USER# ( user -- offs )  up @ - ;  \ USER offset number        : [UP]  up lhld  user# d lxi  d dad ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ interface                                                     \ reset/check labels and stack point                            : READY ( -- sp )  csp @  !lb  !csp ;                           : CHECK ( sp -- )  ?csp  ?lb  csp ! ;                                                                                           : ASM]  avoc @ context ! ;                                                                                                      : END-CODE ( -- )  ?exec  check  asm]  smudge ;                                                                                 \ end macro definition                                          : ENDM ( sys -- )                                                 postpone ;  avoc 2@ context 2!  sys ! ; immediate                                                                                                                                                                                                                                                                             \ interface                                                     \ enter high-level forth, saving BC                             : C: ( -- )  docol call  asm]  ] ;                                                                                              forth definitions assembler                                                                                                     : [ASM ( -- )                                                     context @ avoc !  assembler  <xy> off  postpone [ ; immediate                                                                 : LABEL ( -- )                                                    ?exec  create  smudge  postpone [asm  ready ; immediate                                                                       : CODE ( -- )  postpone label  -3 allot ; immediate                                                                                                                                                                                                             \ interface                                                     : ;CODE ( -- )                                                    postpone (;code)  postpone [asm  ready ; immediate                                                                            \ begin macro definition                                        : MACRO ( -- sys )                                                sys @  context 2@ avoc 2!  assembler definitions  system  : ;                                                                 \ exit high-level forth, restoring BC                           : ;C ( -- )  exit1 compile,  postpone [asm ; immediate                                                                                                                                                                                                                                                                                                                                                                                                          \ discard headers                                               behead avoc ?l                                                  behead <xy> 13m                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 